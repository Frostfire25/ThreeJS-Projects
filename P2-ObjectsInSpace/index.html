<html>
<head>
    <title>(Project 2) Objects in Space</title>
    <!--"Blocker" Code Grabbed from: https://threejs.org/examples/misc_controls_pointerlock.html -->
    <style>
        #blocker {
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        #instructions {
            width: 100%;
            height: 100%;

            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;

            text-align: center;
            font-size: 14px;
            cursor: pointer;
        }
    </style>
</head>
<body>
<div id="blocker">
    <div id="instructions">
        <p style="font-size:36px; font-family: Helvetica, Arial, sans-serif; font-weight: bold; color: rgba(226, 226, 226, 0.75);">
            Click to play
        </p>
        <p style="font-size:16px; font-family: Helvetica, Arial, sans-serif; font-weight: bold; color: rgba(226, 226, 226, 0.75);">
            Look: MOUSE<br />
            Toggle Movement: X<br />
            Toggle Movement Direction: Z
        </p>
    </div>
</div>


<canvas id="myCanvas"></canvas>

<script type="module">

// Objects & Functions
// Gets a random number
// https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/random
function getRandomArbitrary(min, max) {
  return Math.random() * (max - min) + min;
}

// Gets a random integer
// https://stackoverflow.com/questions/1527803/generating-random-whole-numbers-in-javascript-in-a-specific-range
function getRandomArbitraryInt(min, max) {
    min = Math.ceil(min);
    max = Math.floor(max);
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

// Start of Javascript code
import * as THREE from "http://cs.merrimack.edu/~stuetzlec/three.js-master/build/three.module.js";
import { ConvexGeometry } from "http://cs.merrimack.edu/~stuetzlec/three.js-master/examples/jsm/geometries/ConvexGeometry.js";
import { DragControls } from 'http://cs.merrimack.edu/~stuetzlec/three.js-master/examples/jsm/controls/DragControls'
import { PointerLockControls } from 'http://cs.merrimack.edu/~stuetzlec/three.js-master/examples/jsm/controls/PointerLockControls'

/**
 * Initilization function, creating scene, camera, and objects.
 */
// Creating Scene and Camera
var scene = new THREE.Scene();
//scene.fog = new THREE.FogExp2( 0xefd1b5, 0.0005 );


// Renderer 

var renderer = new THREE.WebGLRenderer({canvas: myCanvas, antialias: true});
//renderer.setClearColor( 0xffffff, 1 );
//renderer.setClearColor( new THREE.Color( 'aqua' ), 1 );
// If you want this to span the window, instead of using the myCanvas object, use the window object
renderer.setPixelRatio(window.devicePixelRatio * 1.01);
renderer.setSize(window.innerWidth, window.innerHeight * 1);
renderer.setClearColor(0x000000);
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;

// Adding in the cameras
const cameraGroup = new THREE.Group();

var startingCameraZ = 0;
var camera = new THREE.PerspectiveCamera( 35, window.innerWidth / window.innerHeight, .1, 3000 );
camera.position.z = startingCameraZ;  // Try moving this around!
//camera.lookAt( new THREE.Vector3(0.0,0.0,0.0));
cameraGroup.add( camera );

// Main Camera
var windowWidth = window.innerWidth;
var windowHeight = window.innerHeight;

var rearViewCamera = new THREE.PerspectiveCamera( 35, window.innerWidth / window.innerHeight, .1, 3000 );
rearViewCamera.position.z = startingCameraZ;
//camera.rotate.y = 90 * Math.PI / 180
cameraGroup.add( rearViewCamera );
rearViewCamera.rotation.set(0, 0, -1);
scene.add( cameraGroup );

// Automiattically adjusts video based on resize.
document.body.appendChild( renderer.domElement );
window.addEventListener( 'resize', function() {
    var width = window.innerWidth;
    var height = window.innerHeight;
    renderer.setSize( width, height );
});

// Light
var light = new THREE.PointLight( 0xff7f24, 6, 1000 );
light.position.set( 0, 0, 0 );
light.castShadow = true;            // default false
light.shadow.mapSize.width = 1024;  // default 512
light.shadow.mapSize.height = 1024; // default 512
light.shadow.camera.near = 2;       // default 0.5
light.shadow.camera.far = 1500;  
scene.add(light);

    // Create rocks
//var rock = createRock(2+Math.random()*25, 50, 1000, 300, 300, 400);
//scene.add( rock );

generateRocks(camera.position.z);

class Asteroid {

constructor(mesh, velocity) {
    this.mesh = mesh;
    this.velocity = velocity;
}  

}

var asteroids;
/**
 * Generates the asteroids based off of where the Z of the camera is.\
 */
function generateRocks(cameraZ) {
    
    var numOfRocks = getRandomArbitraryInt(35, 100);
    rocks = [];

    for(var i = 0; i < numOfRocks; i++) {
        var rock = createRock(2+Math.random()*15, 1000, 1000, 300, 500, 900);
        rock.velocity = generateRandomVelocity();
        scene.add( rock );

        var asteroid = new Asteroid(rock, rock.velocity);
        asteroids.push(rock);
    }

}

/**
 Function that creates our asteroids, inspired by https://codepen.io/Divyz/pen/VPrZMy
 */
function createRock(size, spreadX, maxWidth, maxHeight, minDepth, maxDepth){
	var geometry = new THREE.DodecahedronGeometry(size, 1);
    geometry.vertices.forEach(function(v){
    v.x += (0-Math.random()*(size/4));
    v.y += (0-Math.random()*(size/4));
    v.z += (0-Math.random()*(size/4));
  })

  var color = '#111111';
  var color = ColorLuminance(color,2+Math.random()*10);

  /*
  const FS = `
  void main() {
    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
  }
  `;

  const VS = `

  void main() {
    gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);
  }

  `;

  var texture = new THREE.ShaderMaterial({
    uniforms: {},
    fragmentShader: FS,
    vertexShader: VS,
    roughness: 0.8,
    metalness: 1
  });
  */
  
   var texture = new THREE.MeshStandardMaterial({color:color,
                                            shading: THREE.FlatShading,
                                            //shininess: 0.5,
                                            roughness: 0.8,
                                            metalness: 1
                                        });
    

  var cube = new THREE.Mesh(geometry, texture);
  cube.castShadow = true;
  cube.receiveShadow = true;
  cube.scale.set(1+Math.random()*0.4,1+Math.random()*0.8,1+Math.random()*0.4);
	//cube.rotation.y = Math.PI/4;
	//cube.rotation.x = Math.PI/4;
  var x = spreadX/2-Math.random()*spreadX;
  var centeredness = 1-(Math.abs(x)/(maxWidth/2));
  var y = (maxHeight/2-Math.random()*maxHeight)*centeredness;
  var z = /*(maxDepth/2-Math.random()*maxDepth)**/getRandomArbitrary(minDepth, maxDepth) * centeredness * -1;
  cube.position.set(x,y,z)
  cube.r = {};
  cube.r.x = Math.random() * 0.005;
  cube.r.y = Math.random() * 0.005;
  cube.r.z = Math.random() * 0.005;
  return cube;
};

/**
 * Creates the Color, will probably replace for a fragment shader.
 */
function ColorLuminance(hex, lum) {
    // validate hex string
    hex = String(hex).replace(/[^0-9a-f]/gi, '');
    if (hex.length < 6) {
        hex = hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
    }
    lum = lum || 0;

    // convert to decimal and change luminosity
    var rgb = "#", c, i;
    for (i = 0; i < 3; i++) {
        c = parseInt(hex.substr(i*2,2), 16);
        c = Math.round(Math.min(Math.max(0, c + (c * lum)), 255)).toString(16);
        rgb += ("00"+c).substr(c.length);
    }

    return rgb;
}

/**
 * Generating random velocities for rocks to fly in
 */
function generateRandomVelocity() {
    var velocity = Math.random().toFixed(3) * 2;
    var remaining = velocity;
    var posNeg = Math.round(Math.random()); // One or zero for pos/neg
    var xVel = Math.round(Math.random() * remaining);
    remaining -= xVel;
    if(posNeg == 1)
        xVel *= -1;
    var yVel = (Math.random() * remaining).toFixed(3);
    posNeg = Math.round(Math.random()); // One or zero for pos/neg
    remaining -= yVel;
    if(posNeg == 1)
        yVel *= -1;
    var zVel = remaining;
    posNeg = Math.round(Math.random()); // One or zero for pos/neg
    if(posNeg == 1)
        zVel *= -1;

    return new THREE.Vector3(xVel, yVel, zVel);
}

/**
 * Object movement through space
 */
function moveObject(obj, newPos, deltaVal) {
    obj.position.x += newPos.x * deltaVal;
    obj.position.y += newPos.y * deltaVal;
    obj.position.z += newPos.z * deltaVal;
}


/**
 * Camera controls (mouse input)
 * Grabbed from: https://threejs.org/examples/misc_controls_pointerlock.html
 */
const camControls = new PointerLockControls( cameraGroup, document.body );

const blocker = document.getElementById( 'blocker' );
const instructions = document.getElementById( 'instructions' );

instructions.addEventListener( 'click', function () {

    camControls.lock();

} );

camControls.addEventListener( 'lock', function () {

    instructions.style.display = 'none';
    blocker.style.display = 'none';

} );

camControls.addEventListener( 'unlock', function () {

    blocker.style.display = 'block';
    instructions.style.display = '';

} );

var lastTimeStamp = Date.now();
var moving = false;
var tog = false;
var multiplier = 0.2;
// Fields for camera movement
var targetVector = new THREE.Vector3();
function animate() {
    requestAnimationFrame(animate);

    /**
     * Move the camera in space
     */
    var now = Date.now();
    var dt = now - lastTimeStamp;
    lastTimeStamp = now;
    if(moving)
        if(tog) {
            moveObject(camera, camControls.getDirection(targetVector), dt * multiplier); // Move the camera in the +z direction by 1/5 of deltaTime
            moveObject(rearViewCamera, camControls.getDirection(targetVector), dt * multiplier); // Move the camera in the +z direction by 1/5 of deltaTime
        }
        else {
            moveObject(camera, camControls.getDirection(targetVector), dt * multiplier); // Move the camera in the +z direction by 1/5 of deltaTime
            moveObject(rearViewCamera, camControls.getDirection(targetVector), dt * multiplier); // Move the camera in the +z direction by 1/5 of deltaTime
        }
    // Note: This moves the camera by an amount proportionate to the elapsed time, not the frame count.

    /**
     * Move the rocks in space
     */
    rocks.forEach((rock) => {
        moveObject(rock, rock.velocity, dt * multiplier);
    });

    render();
}

document.addEventListener('keypress', keypressed);

function keypressed( event )
{
    

    switch(event.key) {
        /**
         * For testing movement + rendering.
         */
        case "x": {// Starts and stops movement
            moving = !moving;
        }; break;
        case "y": {// Starts and stops movement
            tog = !tog;
        }; break;
        case "z": {// Reverses movement direction
            multiplier *= -1;
        }; break;
    }		
}

function render() {
   
    // Render both cameras.
    /*
    const left = Math.floor( windowWidth * 1 );
    const bottom = Math.floor( windowHeight * 1 );
    const width = Math.floor( windowWidth * 1 );
    const height = Math.floor( windowHeight * 1 );
    renderer.setViewport( left, bottom, width, height );
    renderer.setScissor( left, bottom, width, height );
    */
    renderer.setClearColor(0x000000);
    renderer.setScissorTest( false );
    renderer.render( scene, camera );
    
	rearViewCamera.updateMatrixWorld( true );
    const left2 = Math.floor( windowWidth * 0.30 );
    const bottom2 = Math.floor( windowHeight * 0.80 );
    const width2 = Math.floor( windowWidth * 0.40 );
    const height2 = Math.floor( windowHeight * 0.20 );
    //renderer.setViewport( left2, bottom2, width2, height2 );
    renderer.setScissor( left2, bottom2, width2, height2 );
    renderer.setScissorTest( true );
    renderer.setClearColor(0x111111);
    renderer.render( scene, rearViewCamera );

    //console.log( scene.position );


}

animate();

</script>

</body>
</html>